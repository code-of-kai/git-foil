name: Update Homebrew Tap

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.4)'
        required: true

env:
  TAP_REPO: code-of-kai/homebrew-gitfoil

jobs:
  update-tap:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Determine release tag
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.release_tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          if [ -z "$TAG" ]; then
            echo "release_tag is required" >&2
            exit 1
          fi
          echo "release_tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Compute tarball SHA256
        id: sha
        run: |
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/${{ steps.meta.outputs.release_tag }}.tar.gz"
          SHA=$(curl -Ls "$URL" | sha256sum | awk '{print $1}')
          echo "tarball_url=$URL" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAP_REPO }}
          token: ${{ secrets.TAP_TOKEN }}
          path: tap

      - name: Update formula
        run: |
          cd tap/Formula
          sed -i "s#^  url \".*\"#  url \"${{ steps.sha.outputs.tarball_url }}\"#" git-foil.rb
          sed -i "s#^  sha256 \".*\"#  sha256 \"${{ steps.sha.outputs.sha }}\"#" git-foil.rb

      - name: Commit and push to tap main
        run: |
          cd tap
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add Formula/git-foil.rb
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "git-foil ${{ steps.meta.outputs.release_tag }}: update url & sha256"
          git push origin HEAD:main
        env:
          GIT_TERMINAL_PROMPT: 0
        shell: bash
